<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Cluedo Clue Sheet</title>
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial;
        background: #1f1f1f; /* body background */
        color: #f5f5f5; /* main text */
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      h1 {
        color: #ffd479; /* header text */
        text-align: center;
        margin-bottom: 10px;
      }
      button {
        padding: 8px 16px;
        background: #8b5e3c; /* button background */
        border: none;
        border-radius: 6px;
        color: #f5f5f5; /* button text */
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 16px;
      }
      button:hover {
        background: #ffd479; /* hover background */
        color: #1f1f1f; /* hover text */
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      /* Controls container above table */
      .table-controls {
        display: flex;
        justify-content: space-between;
        width: 90%;
        max-width: 1000px;
        margin-bottom: 10px;
      }
      table {
        border-collapse: collapse;
        width: 90%;
        max-width: 1000px;
        background: #333333; /* table background */
        margin-top: 0;
        position: relative;
        font-size: 16px;
      }
      th,
      td {
        border: 1px solid #444;
        padding: 10px;
        text-align: center;
        min-width: 60px;
        transition: all 0.2s ease;
        position: relative;
      }
      th {
        background: #8b5e3c; /* table headers */
        color: #f5f5f5;
        font-size: 17px;
      }
      td.clickable {
        cursor: pointer;
        transition: all 0.2s ease;
      }
      td.clickable:hover {
        background: #555555; /* subtle hover for cells */
      }
      td.crossed {
        text-decoration: line-through;
        color: #d94f4f; /* crossed cards */
        font-weight: normal;
      }
      td.highlighted {
        color: #ffd479; /* highlighted cards */
        font-weight: bold;
      }
      td.revealed {
        background: #3aafa9; /* revealed card color */
        color: #1f1f1f; /* text contrast on revealed */
        font-weight: bold;
      }
      th.editable,
      td.editable {
        cursor: text;
      }
      td .eye-icon {
        position: absolute;
        top: 2px;
        right: 2px;
        font-size: 12px;
        color: #ffd369;
        pointer-events: none; /* icon won't interfere with clicks */
      }
      #contextMenu {
        position: absolute;
        display: none;
        background: #333333;
        border: 1px solid #ffd479;
        border-radius: 6px;
        box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        padding: 4px;
        gap: 4px;
        white-space: nowrap;
      }
      #contextMenu div {
        padding: 6px 10px;
        cursor: pointer;
        text-align: center;
        font-size: 18px;
        color: #ffd479;
        background: #333333;
        border-radius: 4px;
        transition: all 0.2s ease;
      }
      #contextMenu div:hover {
        background: #ffd479;
        color: #1f1f1f;
      }
    </style>
  </head>
  <body>
    <h1>Cluedo Clue Sheet</h1>

    <div class="table-controls">
      <div>
        <button id="undoBtn">Undo</button>
        <button id="redoBtn">Redo</button>
      </div>
      <div
        id="playerControls"
        style="display: flex; align-items: center; gap: 4px"
      >
        <button id="decreasePlayers" style="padding: 4px 8px; font-size: 14px">
          -
        </button>
        <div
          id="numPlayersDisplay"
          style="font-weight: bold; min-width: 20px; text-align: center"
        >
          3
        </div>
        <button id="increasePlayers" style="padding: 4px 8px; font-size: 14px">
          +
        </button>
      </div>
    </div>

    <table id="sheet"></table>
    <div id="contextMenu"></div>

    <script>
      const categories = [
        {
          title: 'Suspects',
          items: [
            'Miss Scarlet',
            'Colonel Mustard',
            'Mrs. Peacock',
            'Professor Plum',
            'Mr. Green',
            'Dr. Orchid',
          ],
        },
        {
          title: 'Weapons',
          items: [
            'Knife',
            'Candlestick',
            'Revolver',
            'Rope',
            'Lead Pipe',
            'Wrench',
          ],
        },
        {
          title: 'Rooms',
          items: [
            'Kitchen',
            'Ballroom',
            'Conservatory',
            'Dining Room',
            'Lounge',
            'Hall',
            'Study',
            'Library',
            'Billiard Room',
          ],
        },
      ]

      let numPlayers = 3,
        maxPlayers = 6,
        minPlayers = 3
      const sheet = document.getElementById('sheet')
      const numPlayersDisplay = document.getElementById('numPlayersDisplay')
      const contextMenu = document.getElementById('contextMenu')
      const menuOptions = [
        '❌',
        '✅',
        '❓',
        '1️⃣',
        '2️⃣',
        '3️⃣',
        '4️⃣',
        '5️⃣',
        '👁️',
        '🗑️',
      ]
      let currentCell = null
      let history = [],
        historyIndex = -1

      // Build context menu
      menuOptions.forEach((option) => {
        const div = document.createElement('div')
        div.textContent = option
        div.onclick = () => {
          if (!currentCell) return

          // Remove existing icon if any
          const existingIcon = currentCell.querySelector('.eye-icon')

          if (option === '🗑️') {
            currentCell.textContent = ''
            if (existingIcon) existingIcon.remove()
          } else if (option === '👁️') {
            // eye option
            if (existingIcon) existingIcon.remove()
            else {
              const icon = document.createElement('i')
              icon.className = 'ri-eye-line eye-icon'
              currentCell.appendChild(icon)
            }
          } else {
            let symbols = currentCell.textContent.split(' ').filter((s) => s)
            if (['❌', '✅', '❓'].includes(option)) {
              symbols = symbols.includes(option)
                ? symbols.filter((s) => s !== option)
                : symbols
                    .filter((s) => !['❌', '✅', '❓'].includes(s))
                    .concat(option)
            } else
              symbols = symbols.includes(option)
                ? symbols.filter((s) => s !== option)
                : symbols.concat(option)

            currentCell.textContent = symbols.join(' ')
            if (existingIcon) currentCell.appendChild(existingIcon)
          }

          contextMenu.style.display = 'none'
          updateRowLogic(currentCell.parentElement)
          updateKnownCounters()
          saveState()
        }
        contextMenu.appendChild(div)
      })

      // Show context menu
      sheet.addEventListener('click', (e) => {
        if (!e.target.classList.contains('clickable')) {
          contextMenu.style.display = 'none'
          return
        }
        currentCell = e.target
        const rect = e.target.getBoundingClientRect()
        const tableRect = sheet.getBoundingClientRect()
        contextMenu.style.display = 'flex'
        contextMenu.style.flexWrap = 'nowrap'
        contextMenu.style.width = 'auto'

        let left = rect.left + window.scrollX
        let top = rect.bottom + window.scrollY

        if (top + contextMenu.offsetHeight > tableRect.bottom + window.scrollY)
          top = rect.top + window.scrollY - contextMenu.offsetHeight
        if (top < tableRect.top + window.scrollY)
          top = tableRect.top + window.scrollY + 4
        if (left + contextMenu.offsetWidth > tableRect.right + window.scrollX)
          left = Math.max(
            rect.right + window.scrollX - contextMenu.offsetWidth,
            tableRect.right + window.scrollX - contextMenu.offsetWidth - 4
          )
        if (left < tableRect.left + window.scrollX)
          left = tableRect.left + window.scrollX + 4

        contextMenu.style.left = left + 'px'
        contextMenu.style.top = top + 'px'
      })

      document.addEventListener('click', (e) => {
        if (
          !contextMenu.contains(e.target) &&
          !e.target.classList.contains('clickable')
        )
          contextMenu.style.display = 'none'
      })

      function rebuildTable(saveHistory = true) {
        sheet.innerHTML = ''
        const header = document.createElement('tr')
        header.innerHTML =
          `<th>Card</th>` +
          Array.from(
            { length: numPlayers },
            (_, i) =>
              `<th contenteditable="true" class="editable">P${i + 1}</th>`
          ).join('')
        sheet.appendChild(header)

        const knownRow = document.createElement('tr')
        knownRow.id = 'knownCardsRow'
        knownRow.innerHTML =
          `<td>Known</td>` +
          Array.from({ length: numPlayers }, () => `<td>0</td>`).join('')
        sheet.appendChild(knownRow)

        categories.forEach((cat) => {
          const catRow = document.createElement('tr')
          catRow.innerHTML = `<th colspan="${numPlayers + 1}">${cat.title}</th>`
          sheet.appendChild(catRow)
          cat.items.forEach((item) => {
            const row = document.createElement('tr')
            const nameCell = document.createElement('td')
            nameCell.textContent = item
            nameCell.dataset.clickState = '0'
            nameCell.style.cursor = 'pointer'
            nameCell.addEventListener('click', () => {
              let state = parseInt(nameCell.dataset.clickState)
              nameCell.classList.remove('crossed', 'highlighted')
              nameCell.textContent = nameCell.textContent.replace(/^➡️ /, '')
              if (state === 0) {
                nameCell.classList.add('crossed')
                nameCell.dataset.clickState = '1'
              } else if (state === 1) {
                nameCell.classList.add('highlighted')
                nameCell.dataset.clickState = '2'
                nameCell.textContent = '➡️ ' + item
              } else nameCell.dataset.clickState = '0'
              updateRowLogic(row)
              updateKnownCounters()
              saveState()
            })
            row.appendChild(nameCell)
            for (let i = 0; i < numPlayers; i++) {
              const td = document.createElement('td')
              td.className = 'clickable'
              row.appendChild(td)
            }
            sheet.appendChild(row)
          })
        })
        if (saveHistory) saveState()
      }

      function updateRowLogic(row) {
        const cells = Array.from(row.querySelectorAll('td.clickable'))
        const nameCell = row.querySelector('td:first-child')
        const hasCheck = cells.some((c) => c.textContent.includes('✅'))

        if (hasCheck) {
          cells.forEach((c) => {
            if (!c.textContent.includes('✅') && !c.textContent.includes('❌'))
              c.textContent = '❌'
          })
          nameCell.classList.add('crossed')
          nameCell.classList.remove('highlighted')
          nameCell.textContent = nameCell.textContent.replace(/^➡️ /, '')
          return
        }

        const xCount = (
          cells
            .map((c) => c.textContent)
            .join(' ')
            .match(/❌/g) || []
        ).length
        if (xCount >= 3) {
          nameCell.classList.add('highlighted')
          nameCell.classList.remove('crossed')
          if (!nameCell.textContent.startsWith('➡️ '))
            nameCell.textContent = '➡️ ' + nameCell.textContent
        } else {
          if (nameCell.dataset.clickState === '0') {
            nameCell.classList.remove('crossed', 'highlighted')
            nameCell.textContent = nameCell.textContent.replace(/^➡️ /, '')
          }
        }
      }

      function updateKnownCounters() {
        const knownRow = document.getElementById('knownCardsRow')
        for (let i = 0; i < numPlayers; i++) {
          const colIndex = i + 1
          let count = 0
          Array.from(sheet.querySelectorAll('tr')).forEach((row) => {
            const cell = row.children[colIndex]
            if (cell && cell.textContent.includes('✅')) count++
          })
          knownRow.children[colIndex].textContent = count
        }
      }

      function saveState() {
        const state = Array.from(sheet.querySelectorAll('td')).map((td) => ({
          text: td.textContent,
          clickState: td.dataset.clickState || '0',
          revealed: td.classList.contains('revealed'),
        }))
        history = history.slice(0, historyIndex + 1)
        history.push(state)
        historyIndex++
        updateButtons()
      }

      function restoreState(index) {
        const cells = Array.from(sheet.querySelectorAll('td'))
        history[index].forEach((item, i) => {
          const td = cells[i]
          td.textContent = item.text
          td.dataset.clickState = item.clickState
          td.classList.remove('crossed', 'highlighted', 'revealed')
          if (item.revealed) td.classList.add('revealed')
        })
        historyIndex = index
        updateButtons()
      }

      function updateButtons() {
        document.getElementById('undoBtn').disabled = historyIndex <= 0
        document.getElementById('redoBtn').disabled =
          historyIndex >= history.length - 1
      }

      document.getElementById('undoBtn').addEventListener('click', () => {
        if (historyIndex > 0) restoreState(historyIndex - 1)
      })
      document.getElementById('redoBtn').addEventListener('click', () => {
        if (historyIndex < history.length - 1) restoreState(historyIndex + 1)
      })
      document
        .getElementById('increasePlayers')
        .addEventListener('click', () => {
          if (numPlayers < maxPlayers) {
            numPlayers++
            numPlayersDisplay.textContent = numPlayers
            rebuildTable(false)
          }
        })
      document
        .getElementById('decreasePlayers')
        .addEventListener('click', () => {
          if (numPlayers > minPlayers) {
            numPlayers--
            numPlayersDisplay.textContent = numPlayers
            rebuildTable(false)
          }
        })

      rebuildTable()
    </script>
    <footer
      style="
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #ffd369;
      "
    >
      <a
        href="https://github.com/MasterBatess/cluedo-clue-sheet"
        target="_blank"
        style="color: #ffd369; text-decoration: underline"
      >
        Source code
      </a>
    </footer>
  </body>
</html>
